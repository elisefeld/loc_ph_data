---
title: "Newspaper Content Analysis"
author: "Elise Hachfeld and Theresa Worden"
output: 
  flexdashboard::flex_dashboard:
    theme:
      version: 4
      bootswatch: yeti
runtime: shiny
---
```{r global, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidytext)
library(DT)
library(igraph)
library(shinyWidgets)
library(ggraph)
library(gt)
source("data_prep.R")
source("text_analysis.R")
```

```{r import}
#get_all_years("1941", "1942") commenting out because I don't want to run this every time...
pearl_data <- prepare_data(data = "Data/pearl_data.rds")
```

About
=====================================  

Column {data-width="500"}
-------------------------------------

### Background

By [Elise Hachfeld](https://github.com/elisefeld) and [Theresa Worden](https://github.com/wordentheresa0)

The way people consume media has changed drastically since 1941, but has its content? We are interested in how major historical events affect the sentiment of people reflected in the media. To investigate this, we looked at the text of newspapers 3 months before and after the bombing of Pearl Harbor on December 7th, 1941 (from September 7th 1941 to March 7th, 1942.)

We sourced our data from the Library of Congress [Chronicling America](https://www.loc.gov/collections/chronicling-america/about-this-collection/) project, which contains historical American newspapers from 1756 to 1963.

The data was accessed through the Chronicling America API using the [httr2](https://httr2.r-lib.org) and [jsonlite](https://jeroen.r-universe.dev/jsonlite) packages.

View some more Pearl Harbor front pages [here](https://www.nypl.org/blog/2017/12/07/pearl-harbor-front-page).

Column {data-width="500"}
-------------------------------------

```{r picture, echo = F, out.width = '100%'}
knitr::include_graphics("images/pearl_harbor_front_page.png")
```


Overview
=====================================

Sidebar {.sidebar}
-------------------------------------
Say some stuff here I guess??

Row {.tabset .tabset-fade}
-------------------------------------

### By Language
```{r}
pearl_data |>
  filter(!is.na(language)) |>
  count(language, sort = TRUE) |>
  filter(language != "NA") |>
  ggplot(aes(reorder(language, n), n), fill = language) +
  geom_col() +
  coord_flip() +
  labs(title = "Number of Articles by Language",
       subtitle = "September 7th, 1941 to March 7th, 1942",
       x = "Language",
       y = "Count") +
  theme_minimal()
```

### By Language and State
```{r}
#Can we make this filterable?
pearl_data |>
  filter(!is.na(language)) |>
  count(language, state, sort = TRUE) |>
  filter(language != "NA") |>
  ggplot(aes(reorder(language, n), n), fill = language) +
  geom_col() +
  coord_flip() +
  labs(title = "Number of Articles by Language and State",
       subtitle = "September 7th, 1941 to March 7th, 1942",
       x = "Language",
       y = "Count") +
  facet_wrap(~state) +
  theme_minimal()
```

### By Ethnicity
```{r}
pearl_data |>
  filter(!is.na(ethnicity)) |>
  count(ethnicity, sort = TRUE) |>
  ggplot(aes(reorder(ethnicity, n), n)) +
  geom_col() +
  coord_flip() +
  labs(title = "Number of Articles by Ethnicity",
       subtitle = "September 7th, 1941 to March 7th, 1942",
       x = "Ethnicity",
       y = "Count") +
  theme_minimal()
```

### By Newspaper
```{r}
pearl_data |>
  count(newspaper, sort = TRUE) |>
  slice_head(n = 25) |>
  ggplot(aes(factor(reorder(newspaper, n)), n)) +
  geom_col() +
  coord_flip() +
  labs(title = "Number of Articles by Newspaper",
       subtitle = "September 7th, 1941 to March 7th, 1942",
       x = "Newspaper",
       y = "Count") +
  theme_minimal()
```

Common Words
=====================================

Sidebar {.sidebar}
-------------------------------------
Say some stuff here I guess??

Column {data-width="500"}
-------------------------------------
```{r}
source("text_analysis.R")
words <- tokenize_words(data = pearl_data, text_column = text_data, type = "words")
keywords <- get_keywords(data = words)
words_clean <- remove_stopwords(data = words)

inputPanel(
  pickerInput(
    inputId = "newspaper_titles",
    label = "Select Newspaper Title:",
    choices = unique(words_clean$newspaper_title),
    multiple = TRUE,
    options = pickerOptions(actionsBox = TRUE, liveSearch = TRUE)
))

renderTable({
  words_clean |>
    count(word, newspaper_title, sort = TRUE) |>
    head(1000) |>
    filter(newspaper_title %in% c(input$newspaper_titles)) |>
    gt()
})
```

Row {.tabset .tabset-fade}
-------------------------------------

### Common Words
```{r}
words_clean |>
  count(word, sort = TRUE) |>
  slice_max(n, n = 20) |>
  ggplot(aes(fct_reorder(word, n), n)) +
  geom_col() +
  coord_flip() +
  labs(title = "Most Common Words in Front Pages of Newspapers",
       subtitle = "September 7th, 1941 to March 7th, 1942",
       x = "Count",
       y = "Word") +
  theme_minimal()
```

### Before and After Pearl Harbor
```{r}
words_clean |>
  count(word, before_pearl_harbor, sort = TRUE) |>
  group_by(before_pearl_harbor) |>
  slice_max(n, n = 20) |>
  ungroup() |>
  ggplot(aes(fct_reorder(word, n), n, fill = before_pearl_harbor)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  labs(
    title = "Common Words Before and After Pearl Harbor",
    subtitle = "December 7th, 1941",
    x = "Word",
    y = "Count"
  ) +
  facet_wrap(~before_pearl_harbor, scales = "free") +
  theme_minimal()
```

Keywords
=====================================

Sidebar {.sidebar}
-------------------------------------
```{r}
inputPanel(
  pickerInput(
    inputId = "ids",
    label = "Select Keywords:",
    choices = unique(keywords$id),
    multiple = TRUE,
    options = pickerOptions(actionsBox = TRUE, liveSearch = TRUE)
))
```

Column
-------------------------------------
```{r}
renderPlot({
keywords |>
  filter(id %in% c(input$ids)) |>
  count(word, before_pearl_harbor, sort = TRUE) |>
  ggplot(aes(reorder(word, n), n), fill = before_pearl_harbor) +
  geom_col() +
  coord_flip() +
  labs(title = paste0(input$ids, " Keywords in Front Pages of Newspapers"),
       subtitle = "September 7th, 1941 to March 7th, 1942",
       x = "Count",
       y = "Keyword") +
  theme_minimal() +
  facet_wrap(~before_pearl_harbor)
})
```

Sentiment Analysis
=====================================  

Sidebar {.sidebar}
-------------------------------------
Say some stuff here I guess??

Row {.tabset .tabset-fade}
-------------------------------------

### Common Words (Bing Sentiment)
```{r, echo = FALSE}
result <- analyze_sentiment(data = words_clean, type = "bing")
bing <- result[[1]]
bing_avg <- result[[2]]
bing_date <- result[[3]]

bing |>
  group_by(sentiment, word) |>
  summarize(n = n()) |>
  arrange(sentiment, desc(n)) |>
  group_by(sentiment) |>
  slice_max(n, n = 10) |>
  ungroup() |>
  ggplot(aes(reorder(word, n), n, fill = as.factor(sentiment))) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
facet_wrap( ~ sentiment, scales = "free") +
  labs(
    x = "Word",
    y = "Count",
    title = "Most Common Words by Bing Sentiment",
    subtitle = "Based on the Bing Sentiment Lexicon"
  ) +
  theme_minimal()

```

### Common Words (Afinn Sentiment)
```{r, echo = FALSE}
result <- analyze_sentiment(data = words_clean, type = "afinn")
afinn <- result[[1]]
afinn_avg <- result[[2]]
afinn_date <- result[[3]]

afinn |>
  group_by(value, word) |>
  summarize(n = n()) |>
  arrange(value, desc(n)) |>
  group_by(value) |>
  slice_max(n, n = 10) |>
  ungroup() |>
  ggplot(aes(reorder(word, n), n, fill = as.factor(value))) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
facet_wrap( ~ value, scales = "free") +
  labs(
    x = "Word",
    y = "Count",
    title = "Most Common Words by Sentiment",
    subtitle = "Based on the Afinn Sentiment Lexicon"
  ) +
  theme_minimal()
```

### NRC Sentiment
```{r}
nrc <- get_sentiments("nrc")
words |>
  inner_join(nrc) |>
  count(word, sentiment, sort = TRUE) |>
  group_by(sentiment) |>
  slice_max(n, n = 10) |>
  ungroup() |> 
ggplot(aes(x = reorder(word, n), y = n, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  facet_wrap(~ sentiment, scales = "free_y") +
  labs(
    x = "Word",
    y = "Count",
    title = "Top 10 Most Common Words by Sentiment",
    subtitle = "Based on NRC Sentiment Lexicon"
  ) +
  theme_minimal()
```


Row {.tabset .tabset-fade}
-------------------------------------

### Bing Sentiment Over Time

```{r, echo=FALSE}
ggplot(bing_date, aes(x = as.Date(date), y = avg_sentiment, fill = avg_sentiment > 0)) +
  geom_col(show.legend = FALSE) +
    geom_vline(xintercept = as.Date("1941-12-07"), color = "black") +
  labs(
    title = "Average Bing Sentiment Over Time",
    subtitle = "Based on the Bing Sentiment Lexicon",
    x = "Date",
    y = "Average Sentiment",
    caption = "The black line represents the bombing of Pearl Harbor on December 7th, 1941. \n The United States declared war on Japan the next day."
  ) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  theme_minimal()

```

### Afinn Sentiment Over Time
```{r}
result <- analyze_sentiment(data = words_clean, type = "afinn")
afinn <- result[[1]]
afinn_avg <- result[[2]]
afinn_date <- result[[3]]

ggplot(afinn_date, aes(x = as.Date(date), y = avg_sentiment, fill = avg_sentiment > 0)) +
  geom_col(show.legend = FALSE) +
    geom_vline(xintercept = as.Date("1941-12-07"), color = "black") +
  labs(
    title = "Average Afinn Sentiment Over Time",
    subtitle = "Based on the Afinn Sentiment Lexicon",
    x = "Date",
    y = "Average Sentiment",
    caption = "The black line represents the bombing of Pearl Harbor on December 7th, 1941. \n The United States declared war on Japan the next day."
  ) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  theme_minimal()
```

Sentiment by Publisher
===================================== 

Sidebar {.sidebar}
-------------------------------------
Say some stuff here I guess??


Column {data-width="400"}
-------------------------------------

### Box 1

```{r eruptions, echo=FALSE}
renderPlot({
  data <- words |>
    inner_join(nrc, by = "word") |>
    count(publisher, sentiment, sort = TRUE) |>
    group_by(sentiment, publisher) |>
    slice_max(n, n = 10) |>
    ungroup()
    
    data |>
    ggplot(aes(x = reorder(publisher, n), y = n, fill = sentiment)) +
    geom_col(show.legend = FALSE) +
    coord_flip() +
    facet_wrap(~ sentiment, scales = "free_y") +
    labs(title = paste("Sentiments for Publishers in", input$state_selector),
          x = "Publisher",
          y = "Word Count"
    ) +
    theme_minimal()
})
```

### Parameters

```{r}
pickerInput(inputId = "state_selector",
            label = "Select State:",
            choices = str_to_title(unique(words$state)),
            multiple = FALSE,
            options = pickerOptions(actionsBox = TRUE, liveSearch = TRUE))
```

Column {data-width="300"}
-------------------------------------

### Box 3

Talk about the graph here.


ngrams
===================================== 

Sidebar {.sidebar}
-------------------------------------
Say some stuff here I guess??


Column {data-width="300"}
-------------------------------------

```{r}
ngrams <- tokenize_words(data = pearl_data, text_column = text_data, type = "ngrams")
ngrams |>
  count(word, sort = TRUE)
ngram_graph <- get_ngrams(ngrams)

set.seed(2017)

ggraph(ngram_graph, layout = "fr") +
  geom_edge_link() +
  geom_node_point() +
  geom_node_text(aes(label = name), vjust = 1, hjust = 1)
```



