---
title: "newspapers"
author: "Elise Hachfeld"
date: "2024-12-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(httr2)
library(jsonlite)
```

```{r}
base_url <- "https://www.loc.gov/collections/chronicling-america/"
final_results <- data.frame()

get_json_data <- function(params) {
  req <- request(base_url) |>
    req_url_query(!!!params)
  
  response <- req |>
    req_perform() |>
    resp_body_string() |>
    fromJSON()
  
  return(response)
}

parse_json_data <- function(response) {
  data <- flatten(response$results)
  has_more <- is.null(response$pagination["next"][[1]])
  print(paste0("Has more pages: ", has_more))
  return(data)
}
```

```{r}
get_paginated_data <- function(display_level = "page",
                          start_date = "",
                          end_date = "",
                          location_state = "",
                          search_type = "advanced",
                          rows = 20,
                          front_pages_only = "true"){
  final_results <- data.frame()
  page <- 0000000001
  has_more <- TRUE
  
   #while (has_more) {
     print(paste0("Getting page ", page, "..."))
     
       # Set the query parameters
       params <-  list(dl = display_level,
                  start_date = start_date,
                  end_date = end_date,
                  number_page = page,
                  searchType = search_type,
                  front_pages_only = front_pages_only,
                  rows = 20,
                  fo = "json",
                  at = "results,pagination")
       
     response <- get_json_data(params)
     parsed <- parse_json_data(response)
     print(parsed)
     
     final_results <- rbind(final_results, parsed)
     
     has_more = FALSE
     #has_more <- !is.null(parsed$pagination["next"])
     #page <- page + 1
   #}
  print(paste0("Number of results: ", nrow(final_results)))
  final_results <<- final_results
}
```

```{r}
get_paginated_data()

data_clean <- final_results |>
  select(index, date, title, partof_title, description, url, image_url, language, location_country, location_state, location_county, location_city, contributor, number_page, publication_frequency)
```


